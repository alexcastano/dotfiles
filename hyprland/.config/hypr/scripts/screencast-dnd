#!/bin/bash
# Disable notifications during screen sharing
# Monitors DBus for xdg-desktop-portal screencast events
# Preserves user's manual DND state

STATE_FILE="/tmp/screencast-dnd-state"

dbus-monitor --session "interface='org.freedesktop.portal.ScreenCast'" \
                       "interface='org.freedesktop.portal.Session'" 2>/dev/null | \
while read -r line; do
    case "$line" in
        *"interface=org.freedesktop.portal.ScreenCast; member=Start"*)
            # Screen sharing started
            if ! makoctl mode | grep -q "do-not-disturb"; then
                dnd-toggle --enable
                touch "$STATE_FILE"
            fi
            ;;
        *"interface=org.freedesktop.portal.Session; member=Close"*)
            # Screen sharing stopped
            if [[ -f "$STATE_FILE" ]]; then
                dnd-toggle --disable
                rm -f "$STATE_FILE"
            fi
            ;;
    esac
done
